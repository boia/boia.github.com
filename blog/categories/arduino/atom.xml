<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Arduino | boia's博客]]></title>
  <link href="http://boia.github.com/blog/categories/arduino/atom.xml" rel="self"/>
  <link href="http://boia.github.com/"/>
  <updated>2013-08-14T08:57:05+08:00</updated>
  <id>http://boia.github.com/</id>
  <author>
    <name><![CDATA[boia]]></name>
    <email><![CDATA[zhengwang2314@qq.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Arduino链接yeelink实现物联网]]></title>
    <link href="http://boia.github.com/blog/2013/03/08/arduino-yeelink/"/>
    <updated>2013-03-08T19:55:00+08:00</updated>
    <id>http://boia.github.com/blog/2013/03/08/arduino-yeelink</id>
    <content type="html"><![CDATA[<h2>Arduino</h2>

<p>Arduino Mega2560买来也将近一个多月了，一直放着没用，昨天想着试试Ethernet Shield，将Arduino作为一个服务器，在浏览器上可以控制Arduino，本来想着也不是太难，但自己真正搞起来了就不是那么一回事了。</p>

<br>


<p>{% img /images/post/ethernet.png 320 240 Arduino Yeelink %}</p>

<!-- more -->


<br>


<h3>搭建局域网</h3>

<p>先不连到网络，来搭建一个局域网，将本机和Arduino用网线连起来(用路由器的自动获取IP应该更简单一点)，</p>

<h3>下载程序配置</h3>

<p>昨天在Windows XP下找驱动，发现在网上到处找不到，今天上午就在Arduino软件下(我用的是Arduino1.0.3)看到了Drivers文件夹，这让我情何以堪啊，不过需要注意的是在设备管理器下更新驱动程序选择文件夹最好选drivers而不是FTDI USB Drivers。</p>

<p>接着烧程序，因为官方写了Ethernet程序库，所以我就随便选了个，打开<code>File/Examples/Ethernet/WebServe</code>文件，然后将程序中的
<code>
IPAddress ip(192,168,1, 177);
</code>
改成你本机IP的同一段</p>

<p>打开浏览器输入<code>http://192.168.1.177</code>，注意<strong>输入的是你设置的IP</strong>，简单的WebServer就搭建起来了</p>

<h3>Yeelink</h3>

<p>早就听说<strong>物联网</strong>这个词了，却一直没有真正地去探索
接入Yeelink平台, 并通过应用进行远程管理和控制, 使您的设备快速迈进物联网时代。</p>

<p><a href="" title="http://www.yeelink.net/develop/quickstart">快速开始</a>这里有关于yeelink用户注册，新建设备，加传感器初级教程，这里就不细说了。</p>

<p>{% codeblock yeelink%}
 /<em>
 Yeelink sensor client power switch example
 </em>/</p>

<h1>include &lt;SPI.h></h1>

<h1>include &lt;Ethernet.h></h1>

<h1>include &lt;Wire.h></h1>

<h1>include &lt;math.h></h1>

<p>byte buff[2];</p>

<p>// for yeelink api</p>

<h1>define APIKEY         "*****" // replace your yeelink api key here</h1>

<h1>define DEVICEID        // replace your device ID</h1>

<h1>define SENSORID        // replace your sensor ID</h1>

<p>// assign a MAC address for the ethernet controller.
byte mac[] = { 0x00, 0x1D, 0x72, 0x82, 0x35, 0x9D};
// initialize the library instance:
EthernetClient client;
char server[] = "api.yeelink.net";   // name address for yeelink API</p>

<p>unsigned long lastConnectionTime = 0;          // last time you connected to the server, in milliseconds
boolean lastConnected = false;                 // state of the connection last time through the main loop
const unsigned long postingInterval = 3*1000; // delay between 2 datapoints, 30s
String returnValue = "";
boolean ResponseBegin = false;</p>

<p>void setup() {
  pinMode(7, OUTPUT);</p>

<p>  Wire.begin();
  // start serial port:
  Serial.begin(57600);
  // start the Ethernet connection with DHCP:
  if (Ethernet.begin(mac) == 0) {</p>

<pre><code>Serial.println("Failed to configure Ethernet using DHCP");
for(;;)
  ;
</code></pre>

<p>  }
  else {</p>

<pre><code>Serial.println("Ethernet configuration OK");
</code></pre>

<p>  }
}</p>

<p>void loop() {
  // if there's incoming data from the net connection.
  // send it out the serial port.  This is for debugging
  // purposes only:</p>

<p>  if (client.available()) {</p>

<pre><code>char c = client.read();
</code></pre>

<p>   // Serial.print(c);</p>

<pre><code>  if (c == '{')
    ResponseBegin = true;
  else if (c == '}')
    ResponseBegin = false;

  if (ResponseBegin)
    returnValue += c;   
</code></pre>

<p>  }
  if (returnValue.length() !=0 &amp;&amp; (ResponseBegin == false))
  {</p>

<pre><code>Serial.println(returnValue);

if (returnValue.charAt(returnValue.length() - 1) == '1') {
  Serial.println("turn on the LED"); 
  digitalWrite(7, HIGH);

} 
  else if(returnValue.charAt(returnValue.length() - 1) == '0') {
  Serial.println("turn off the LED"); 
  digitalWrite(7, LOW);
}
 returnValue = "";
</code></pre>

<p>  }
  // if there's no net connection, but there was one last time
  // through the loop, then stop the client:
  if (!client.connected() &amp;&amp; lastConnected) {</p>

<pre><code>Serial.println();
Serial.println("disconnecting.");
client.stop();
</code></pre>

<p>  }</p>

<p>  // if you're not connected, and ten seconds have passed since
  // your last connection, then connect again and send data:
  if(!client.connected() &amp;&amp; (millis() - lastConnectionTime > postingInterval)) {</p>

<pre><code>// read sensor data, replace with your code
//int sensorReading = readLightSensor();
Serial.print("yeelink:");
//get data from server  
getData();
</code></pre>

<p>  }
  // store the state of the connection for next time through
  // the loop:
  lastConnected = client.connected();
}</p>

<p>// this method makes a HTTP connection to the server and get data back
void getData(void) {
  // if there's a successful connection:
  if (client.connect(server, 80)) {</p>

<pre><code>Serial.println("connecting...");
// send the HTTP GET request:

client.print("GET /v1.0/device/");
client.print(DEVICEID);
client.print("/sensor/");
client.print(SENSORID);
client.print("/datapoints");
client.println(" HTTP/1.1");
client.println("Host: api.yeelink.net");
client.print("Accept: *");
client.print("/");
client.println("*");
client.print("U-ApiKey: ");
client.println(APIKEY);
client.println("Content-Length: 0");
client.println("Connection: close");
client.println();
Serial.println("print get done.");
</code></pre>

<p>  }
  else {</p>

<pre><code>// if you couldn't make a connection:
Serial.println("connection failed");
Serial.println();
Serial.println("disconnecting.");
client.stop();
</code></pre>

<p>  }
   // note the time that the connection was made or attempted:
  lastConnectionTime = millis();
}
{% endcodeblock %}</p>

<p>你只要将程序中的三个常量APIKEY DEVICEID SENSORID改成你自己在yeelink上得到的值。</p>

<br>


<h3>附上两张照片</h3>

<br>


<p>{% img left /images/post/arduino2.png "Arduino Yeelink" "Arduino Yeelink" %}</p>

<br><br>


<p>{% img left /images/post/arduino3.png "Arduino Yeelink" "Arduino Yeelink" %}</p>

<p> {% include links %}</p>
]]></content>
  </entry>
  
</feed>
